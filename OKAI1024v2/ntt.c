#include <stdint.h>
#include "params.h"
#include "ntt.h"
#include "reduce.h"

const int16_t tntt_zetas[128] = {
        -3593, 3777, -3182, 3625, 3696, 1100, -2456, -2194,
        -2250, -121, -2495, -834, -2876, -2319, -1414, -1701,
        2237,-1986, 2088, 2816, 3706, -2006, 1993, 1599,
        -1483, 1296, -1525, -2557, 1921, -617, 2830, -3364,
        1887, -810, -7, 638, 3600, 3266, -3689, -1738,
        -396, 3174, 3555, 1881, -1305, -1760, -679, 438,
        -2310, 3153, 1535, -549, -3772, 2535, 2440, 2555,
        -2043, -1431, 2804, 103, -1321, -1399, 2956, 514,
        2919, 2789, -194, 3417, 2113, 2732, -2385, 3405,
        -2, -915, -2426, -3831, -1054, 1698, -3456, 1166,
        -2572, -1497, -1350, -3145, -3588, 2224, 2883, 1681,
        -1756, 3135, -2391, 660, -3692, 730, -373, 2175,
        -2743, 921, -1386, 3428, -1533, 1464, -727, 1521,
        -1598, -1390, -2762, 3750, 2764, -2835, 3816, 2233,
        3480, 2133, -3310, -1168, -1799, 2665, -783, -1056,
        2579, 859, 2160, -2649, -404, -486, 1532, 1919};

int16_t zetas[64] = {
  2919, 2789, -194, 3417, 2113, 2732, -2385, 3405,
        -2, -915, -2426, -3831, -1054, 1698, -3456, 1166,
        -2572, -1497, -1350, -3145, -3588, 2224, 2883, 1681,
        -1756, 3135, -2391, 660, -3692, 730, -373, 2175,
        -2743, 921, -1386, 3428, -1533, 1464, -727, 1521,
        -1598, -1390, -2762, 3750, 2764, -2835, 3816, 2233,
        3480, 2133, -3310, -1168, -1799, 2665, -783, -1056,
        2579, 859, 2160, -2649, -404, -486, 1532, 1919
};

int16_t zetas_inv[128] = {
  5762, 6149, 486, 404, 2649, 5521, 6822, 5102, 1056, 783, 5016, 1799, 1168, 3310, 5548, 4201, 5448, 3865, 2835, 4917, 3931, 2762, 1390, 1598, 6160, 727, 6217, 1533, 4253, 1386, 6760, 2743, 5506, 373, 6951, 3692, 7021, 2391, 4546, 1756, 6000, 4798, 5457, 3588, 3145, 1350, 1497, 2572, 6515, 3456, 5983, 1054, 3831, 2426, 915, 2, 4276, 2385, 4949, 5568, 4264, 194, 4892, 4762, 7167, 4725, 1399, 1321, 7578, 4877, 1431, 2043, 5126, 5241, 5146, 3772, 549, 6146, 4528, 2310, 7243, 679, 1760, 1305, 5800, 4126, 4507, 396, 1738, 3689, 4415, 4081, 7043, 7, 810, 5794, 3364, 4851, 617, 5760, 2557, 1525, 6385, 1483, 6082, 5688, 2006, 3975, 4865, 5593, 1986, 5444, 1701, 1414, 2319, 2876, 834, 2495, 121, 2250, 2194, 2456, 6581, 3985, 4056, 3182, 3904, 3824};

int16_t zetas_asm[128] = {
  // 7 & 6 & 5 & 4 layers
  0, 3777, -3182, 3625, 3696, 1100, -2456, -2194,-2250, -121, -2495, -834, -2876, -2319, -1414, -1701,
  // 1st loop of 3 & 2 & 1 layers
  2237,1887,-810,2919,2789,-194,3417,-1986,-7,638,2113,2732, -2385, 3405,
  // 2nd loop of 3 & 2 & 1 layers
  2088,3600,3266,-2,-915, -2426,-3831,2816,-3689, -1738,-1054, 1698, -3456, 1166,
  // 3rd loop of 3 & 2 & 1 layers
  3706,-396,3174,-2572,-1497, -1350, -3145,-2006,3555, 1881,-3588, 2224, 2883, 1681,
  // 4th loop of 3 & 2 & 1 layers
  1993,-1305,-1760,-1756, 3135, -2391, 660,1599,-679, 438,-3692, 730, -373, 2175,
  // 5th loop of 3 & 2 & 1 layers
  -1483,-2310,3153,-2743, 921, -1386, 3428,1296,1535, -549,-1533, 1464, -727, 1521,
  // 6th loop of 3 & 2 & 1 layers
  -1525,-3772, 2535,-1598, -1390, -2762, 3750,-2557,2440, 2555,2764, -2835, 3816, 2233,
  // 7th loop of 3 & 2 & 1 layers
  1921,-2043,-1431,3480, 2133, -3310, -1168,-617,2804, 103,-1799, 2665, -783, -1056,
  // 8th loop of 3 & 2 & 1 layers
  2830,-1321,-1399,2579, 859, 2160, -2649,-3364,2956, 514,-404, -486, 1532, 1919
  };

int32_t zetas_forward[128]={2403302883, 678270451, 3218569426, 294681392, 3820233898, 966241829, 3968972513, 1556722947, 490949263, 1270988240, 446775013, 388621569, 772210629, 3246527812, 3531144184, 2815968664, 4110441947, 3522197501, 2940103899, 3228075277, 1523172883, 2814291161, 1032223621, 4090871077, 2576085710, 3885656522, 2350741117, 1722236594, 1195500597, 2251768429, 1539388748, 387503234, 3336553816, 1889986911, 1380585114, 54239270, 1003146899, 3673172786, 1426436867, 1907321111, 3691066153, 2888101300, 1192145590, 1341443373, 1677503176, 112951881, 135877758, 3866644819, 1610962216, 1367724256, 377438215, 3026774896, 2650455017, 1402392655, 2366397813, 295240559, 2963588943, 2566020691, 3575877602, 925422585, 326553952, 1551131270, 972951842, 110715210, 3407568117, 1153563017, 1621586403, 2512340589, 492067599, 2337321091, 4172509565, 3288465391, 3381846402, 3178868517, 485916754, 2149440736, 4116592792, 226462929, 2675058397, 2718673480, 2547568156, 3511014146, 2118686511, 2516813931, 2538621472, 3468517399, 4151261191, 1054590330, 1438738557, 3612782672, 1433146880, 1718322420, 2300975189, 1265955730, 3649128574, 2562106517, 3932626611, 2573849039, 2862379585, 1610403049, 2319986892, 3503744966, 940520114, 3258829502, 560845229, 1590273011, 1700429052, 3711196192, 3507659140, 555253551, 2772912749, 3261625341, 3987425048, 686657967, 613406995, 889635851, 1133992147, 1091495400, 1142938830, 804083189, 2795838626, 395331582, 2623055799, 2845045385, 233172942, 2181313296, 3665903606,0};

int16_t zetas_inv_asm[128] = {
  // 1 layer
  5762, 6149, 486, 404, 2649, 5521, 6822, 5102, 1056, 783, 5016, 1799, 1168, 3310, 5548, 4201, 5448, 3865, 2835, 4917, 3931, 2762, 1390, 1598, 6160, 727, 6217, 1533, 4253, 1386, 6760, 2743, 5506, 373, 6951, 3692, 7021, 2391, 4546, 1756, 6000, 4798, 5457, 3588, 3145, 1350, 1497, 2572, 6515, 3456, 5983, 1054, 3831, 2426, 915, 2, 4276, 2385, 4949, 5568, 4264, 194, 4892, 4762, 
  // 1st loop of 2 & 3 & 4 layers
  7167, 4725, 1399, 1321,  3364, 4851,  1701, 
  // 2nd loop of 2 & 3 & 4 layers
  7578, 4877, 1431, 2043,  617, 5760,  1414, 
  // 3rd loop of 2 & 3 & 4 layers
  5126, 5241, 5146, 3772,  2557, 1525,  2319, 
  // 4th loop of 2 & 3 & 4 layers
  549, 6146, 4528, 2310,  6385, 1483,  2876, 
  // 5th loop of 2 & 3 & 4 layers
  7243, 679, 1760, 1305,  6082, 5688,  834, 
  // 6th loop of 2 & 3 & 4 layers
  5800, 4126, 4507, 396,  2006, 3975,  2495, 
  // 7th loop of 2 & 3 & 4 layers
  1738, 3689, 4415, 4081,  4865, 5593,  121, 
  // 8th loop of 2 & 3 & 4 layers
  7043, 7, 810, 5794,  1986, 5444,  2250, 
  // 5 & 6 & 7 layers
  2194, 2456, 6581, 3985, 4056, 3182, 1788, // 3904 -> 1788
  // 128^-1 * 2^32
  3824
};

/*************************************************
* Name:        fqmul
*
* Description: Multiplication followed by Montgomery reduction
*
* Arguments:   - int16_t a: first factor
*              - int16_t b: second factor
*
* Returns 16-bit integer congruent to a*b*R^{-1} mod q
**************************************************/
static int16_t fqmul(int16_t a, int16_t b) {
  return montgomery_reduce((int32_t)a*b);
}

/*************************************************
* Name:        ntt
*
* Description: Inplace number-theoretic transform (NTT) in Rq
*              input is in standard order, output is in bitreversed order
*
* Arguments:   - int16_t r[256]: pointer to input/output vector of elements of Zq
**************************************************/
void ntt(int16_t r[256]) {
  unsigned int len, start, j, k;
  int16_t t, zeta;

  k = 1;
  for(len = 128; len >= 2; len >>= 1) {
    for(start = 0; start < 256; start = j + len) {
      zeta = zetas[k++];
      for(j = start; j < start + len; ++j) {
        t = fqmul(zeta, r[j + len]);  // t is in normal domain -q < t < q
        r[j + len] = r[j] - t;
        r[j] = r[j] + t;
      }
    }
    if(len == 32 || len == 4) {
      for(unsigned int i = 0; i < 256; i++) {
        r[i] = barrett_reduce(r[i]);
      }
    }
  }
}

void hntt_ntt(int16_t r[512])
{
  hntt_ntt_fast(r);
}

extern void ntt_fast(int16_t *, const int16_t *);
void hntt_ntt_fast(int16_t r[512])
{
  ntt_fast(r, zetas_asm);
  ntt_fast(r+256, zetas_asm);
}

/*************************************************
* Name:        invntt
*
* Description: Inplace inverse number-theoretic transform in Rq
*              input is in bitreversed order, output is in standard order
*
* Arguments:   - int16_t r[256]: pointer to input/output vector of elements of Zq
**************************************************/
void invntt(int16_t r[256]) {
  unsigned int start, len, j, k;
  int16_t t, zeta;

  k = 0;
  for(len = 2; len <= 128; len <<= 1) {
    for(start = 0; start < 256; start = j + len) {
      zeta = zetas_inv[k++];
      for(j = start; j < start + len; ++j) {
        t = r[j];  // -2q < t < 2q
        r[j] = t + r[j + len];
        r[j + len] = t - r[j + len];
        r[j + len] = fqmul(zeta, r[j + len]);  // r still in mont-1 domain
      }
    }
    if(len == 4 || len == 16 || len == 64) {
    // if(len == 4 || len == 16 || len == 64) {
      for(unsigned int i = 0; i < 256; i++) {
        r[i] = barrett_reduce(r[i]);
      }
    }
  }

  for(j = 0; j < 256; ++j)
    r[j] = fqmul(r[j], zetas_inv[127]);
}

void hntt_invntt(int16_t r[512])
{
  hntt_invntt_fast(r);
}

extern void invntt_fast(int16_t *, const int16_t *);
void hntt_invntt_fast(int16_t r[512]) {
  invntt_fast(r, zetas_inv_asm);
  invntt_fast(r+256, zetas_inv_asm);
}