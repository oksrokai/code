#include <stdint.h>
#include "params.h"
#include "ntt.h"
#include "reduce.h"

int16_t zetas[128] = {
  4088, 3777, 4499, 3625, 3696, 1100, 5225, 5487, 5431, 7560, 5186, 6847, 4805, 5362, 6267, 5980, 2237, 5695, 2088, 2816, 3706, 5675, 1993, 1599, 6198, 1296, 6156, 5124, 1921, 7064, 2830, 4317, 1887, 6871, 7674, 638, 3600, 3266, 3992, 5943, 7285, 3174, 3555, 1881, 6376, 5921, 7002, 438, 5371, 3153, 1535, 7132, 3909, 2535, 2440, 2555, 5638, 6250, 2804, 103, 6360, 6282, 2956, 514, 2919, 2789, 7487, 3417, 2113, 2732, 5296, 3405, 7679, 6766, 5255, 3850, 6627, 1698, 4225, 1166, 5109, 6184, 6331, 4536, 4093, 2224, 2883, 1681, 5925, 3135, 5290, 660, 3989, 730, 7308, 2175, 4938, 921, 6295, 3428, 6148, 1464, 6954, 1521, 6083, 6291, 4919, 3750, 2764, 4846, 3816, 2233, 3480, 2133, 4371, 6513, 5882, 2665, 6898, 6625, 2579, 859, 2160, 5032, 7277, 7195, 1532, 1919};

int16_t zetas_inv[128] = {
  5762, 6149, 486, 404, 2649, 5521, 6822, 5102, 1056, 783, 5016, 1799, 1168, 3310, 5548, 4201, 5448, 3865, 2835, 4917, 3931, 2762, 1390, 1598, 6160, 727, 6217, 1533, 4253, 1386, 6760, 2743, 5506, 373, 6951, 3692, 7021, 2391, 4546, 1756, 6000, 4798, 5457, 3588, 3145, 1350, 1497, 2572, 6515, 3456, 5983, 1054, 3831, 2426, 915, 2, 4276, 2385, 4949, 5568, 4264, 194, 4892, 4762, 7167, 4725, 1399, 1321, 7578, 4877, 1431, 2043, 5126, 5241, 5146, 3772, 549, 6146, 4528, 2310, 7243, 679, 1760, 1305, 5800, 4126, 4507, 396, 1738, 3689, 4415, 4081, 7043, 7, 810, 5794, 3364, 4851, 617, 5760, 2557, 1525, 6385, 1483, 6082, 5688, 2006, 3975, 4865, 5593, 1986, 5444, 1701, 1414, 2319, 2876, 834, 2495, 121, 2250, 2194, 2456, 6581, 3985, 4056, 3182, 3904, 3824};

int16_t zetas_asm[128] = {
		3777, 4499, 3625, 3696, 1100, 5225, 5487,
		5431, 2237, 5695, 1887, 6871, 7674, 638,
		7560, 2088, 2816, 3600, 3266, 3992, 5943,
		5186, 3706, 5675, 7285, 3174, 3555, 1881,
		6847, 1993, 1599, 6376, 5921, 7002, 438,
		4805, 6198, 1296, 5371, 3153, 1535, 7132,
		5362, 6156, 5124, 3909, 2535, 2440, 2555,
		6267, 1921, 7064, 5638, 6250, 2804, 103,
		5980, 2830, 4317, 6360, 6282, 2956, 514,
		2919, 2789, 7487, 3417, 2113, 2732, 5296, 3405, 7679, 6766, 5255, 3850, 6627, 1698, 4225, 1166, 5109, 6184, 6331, 4536, 4093, 2224, 2883, 1681, 5925, 3135, 5290, 660, 3989, 730, 7308, 2175, 4938, 921, 6295, 3428, 6148, 1464, 6954, 1521, 6083, 6291, 4919, 3750, 2764, 4846, 3816, 2233, 3480, 2133, 4371, 6513, 5882, 2665, 6898, 6625, 2579, 859, 2160, 5032, 7277, 7195, 1532, 1919
};

int16_t zetas_inv_asm[128] = {
  // 1 layer
  5762, 6149, 486, 404, 2649, 5521, 6822, 5102, 1056, 783, 5016, 1799, 1168, 3310, 5548, 4201, 5448, 3865, 2835, 4917, 3931, 2762, 1390, 1598, 6160, 727, 6217, 1533, 4253, 1386, 6760, 2743, 5506, 373, 6951, 3692, 7021, 2391, 4546, 1756, 6000, 4798, 5457, 3588, 3145, 1350, 1497, 2572, 6515, 3456, 5983, 1054, 3831, 2426, 915, 2, 4276, 2385, 4949, 5568, 4264, 194, 4892, 4762, 
  // 1st loop of 2 & 3 & 4 layers
  7167, 4725, 1399, 1321,  3364, 4851,  1701, 
  // 2nd loop of 2 & 3 & 4 layers
  7578, 4877, 1431, 2043,  617, 5760,  1414, 
  // 3rd loop of 2 & 3 & 4 layers
  5126, 5241, 5146, 3772,  2557, 1525,  2319, 
  // 4th loop of 2 & 3 & 4 layers
  549, 6146, 4528, 2310,  6385, 1483,  2876, 
  // 5th loop of 2 & 3 & 4 layers
  7243, 679, 1760, 1305,  6082, 5688,  834, 
  // 6th loop of 2 & 3 & 4 layers
  5800, 4126, 4507, 396,  2006, 3975,  2495, 
  // 7th loop of 2 & 3 & 4 layers
  1738, 3689, 4415, 4081,  4865, 5593,  121, 
  // 8th loop of 2 & 3 & 4 layers
  7043, 7, 810, 5794,  1986, 5444,  2250, 
  // 5 & 6 & 7 layers
  2194, 2456, 6581, 3985, 4056, 3182, 1788, // 3904 -> 1788
  // 128^-1 * 2^32
  3824
};

/*************************************************
* Name:        fqmul
*
* Description: Multiplication followed by Montgomery reduction
*
* Arguments:   - int16_t a: first factor
*              - int16_t b: second factor
*
* Returns 16-bit integer congruent to a*b*R^{-1} mod q
**************************************************/
static int16_t fqmul(int16_t a, int16_t b) {
  return montgomery_reduce((int32_t)a*b);
}

/*************************************************
* Name:        ntt
*
* Description: Inplace number-theoretic transform (NTT) in Rq
*              input is in standard order, output is in bitreversed order
*
* Arguments:   - int16_t r[256]: pointer to input/output vector of elements of Zq
**************************************************/
extern void ntt_fast(int16_t *, const int16_t *);
void ntt(int16_t r[256]) {
  ntt_fast(r, zetas_asm);
}

/*************************************************
* Name:        invntt
*
* Description: Inplace inverse number-theoretic transform in Rq
*              input is in bitreversed order, output is in standard order
*
* Arguments:   - int16_t r[256]: pointer to input/output vector of elements of Zq
**************************************************/
extern void invntt_fast(int16_t *, const int16_t *);
void invntt(int16_t r[256]){
  invntt_fast(r, zetas_inv_asm);
}

/*************************************************
* Name:        basemul
*
* Description: Multiplication of polynomials in Zq[X]/((X^2-zeta))
*              used for multiplication of elements in Rq in NTT domain
*
* Arguments:   - int16_t r[2]: pointer to the output polynomial
*              - const int16_t a[2]: pointer to the first factor
*              - const int16_t b[2]: pointer to the second factor
*              - int16_t zeta: integer defining the reduction polynomial
**************************************************/
void basemul(int16_t r[2], const int16_t a[2], const int16_t b[2], int16_t zeta) {
  r[0]  = fqmul(a[1], b[1]);  // -2q^2 < a[1]b[1] < 4q^2
  r[0]  = fqmul(r[0], zeta);
  r[0] += fqmul(a[0], b[0]);  // r[0] is in mont-1 domain -2q < r[0] < 2q

  r[1]  = fqmul(a[0], b[1]);
  r[1] += fqmul(a[1], b[0]);  // r[1] is also in mont-1 domain -2q < r[1] < 2q
}
