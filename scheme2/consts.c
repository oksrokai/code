#include <stdint.h>
#include "params.h"
#include "consts.h"

const uint16_t zetas_exp[396] = {28865, 28865, 3777, 3777, 55187, 55187, 4499, 4499, 61040, 61040, 61040, 61040, 61040, 61040, 61040, 61040, 7244, 7244, 7244, 7244, 7244, 7244, 7244, 7244, 3696, 3696, 3696, 3696, 3696, 3696, 3696, 3696, 1100, 1100, 1100, 1100, 1100, 1100, 1100, 1100, 41783, 41783, 41783, 41783, 11656, 11656, 11656, 11656, 22594, 22594, 22594, 22594, 47295, 47295, 47295, 47295, 5431, 5431, 5431, 5431, 7560, 7560, 7560, 7560, 5186, 5186, 5186, 5186, 6847, 6847, 6847, 6847, 58045, 58045, 46143, 46143, 22568, 22568, 2816, 2816, 49786, 49786, 3115, 3115, 31177, 31177, 42047, 42047, 2237, 2237, 5695, 5695, 2088, 2088, 2816, 2816, 3706, 3706, 5675, 5675, 1993, 1993, 1599, 1599, 58719, 59607, 53754, 15998, 11792, 20674, 16280, 42295, 26229, 6246, 29667, 39257, 59624, 14625, 36698, 44470, 1887, 6871, 7674, 638, 3600, 3266, 3992, 5943, 7285, 3174, 3555, 1881, 6376, 5921, 7002, 438, 63847, 47935, 27201, 29872, 15359, 17031, 32739, 62081, 24053, 11963, 27133, 12611, 49445, 10410, 39317, 46220, 2919, 7487, 2113, 5296, 7679, 5255, 6627, 4225, 5109, 6331, 4093, 2883, 5925, 5290, 3989, 7308, 13541, 40793, 58028, 1869, 13934, 58122, 2722, 24718, 26664, 33208, 26800, 2193, 43583, 43668, 30426, 9855, 2789, 3417, 2732, 3405, 6766, 3850, 1698, 1166, 6184, 4536, 2224, 1681, 3135, 660, 730, 2175, 16425, 16425, 3625, 3625, 50793, 50793, 50793, 50793, 50793, 50793, 50793, 50793, 4975, 4975, 4975, 4975, 4975, 4975, 4975, 4975, 5225, 5225, 5225, 5225, 5225, 5225, 5225, 5225, 5487, 5487, 5487, 5487, 5487, 5487, 5487, 5487, 64709, 64709, 64709, 64709, 47346, 47346, 47346, 47346, 44667, 44667, 44667, 44667, 20316, 20316, 20316, 20316, 4805, 4805, 4805, 4805, 5362, 5362, 5362, 5362, 6267, 6267, 6267, 6267, 5980, 5980, 5980, 5980, 50230, 50230, 9488, 9488, 45068, 45068, 39940, 39940, 59777, 59777, 19352, 19352, 26382, 26382, 10973, 10973, 6198, 6198, 1296, 1296, 6156, 6156, 5124, 5124, 1921, 1921, 7064, 7064, 2830, 2830, 4317, 4317, 43771, 36433, 9215, 21468, 63813, 63463, 6536, 40955, 25094, 44138, 29428, 61031, 51416, 60554, 41868, 50690, 5371, 3153, 1535, 7132, 3909, 2535, 2440, 2555, 5638, 6250, 2804, 103, 6360, 6282, 2956, 514, 26442, 26263, 40964, 12074, 15811, 41271, 8908, 57064, 15768, 55059, 51962, 48882, 53267, 59504, 22125, 32252, 4938, 6295, 6148, 6954, 6083, 4919, 2764, 3816, 3480, 4371, 5882, 6898, 2579, 2160, 7277, 1532, 5529, 21860, 30136, 51185, 56979, 39590, 12014, 23225, 4693, 56177, 48233, 48097, 22875, 25512, 61979, 9599, 921, 3428, 1464, 1521, 6291, 3750, 4846, 2233, 2133, 6513, 2665, 6625, 859, 5032, 7195, 1919};

const uint16_t zetas_inv_exp[396] = {55938, 3558, 40025, 42662, 17440, 17304, 9360, 60844, 42312, 53523, 25947, 8558, 14352, 35401, 43677, 60008, 5762, 486, 2649, 6822, 1056, 5016, 1168, 5548, 5448, 2835, 3931, 1390, 6160, 6217, 4253, 6760, 33285, 43412, 6033, 12270, 16655, 13575, 10478, 49769, 8473, 56629, 24266, 49726, 53463, 24573, 39274, 39095, 6149, 404, 5521, 5102, 783, 1799, 3310, 4201, 3865, 4917, 2762, 1598, 727, 1533, 1386, 2743, 14847, 23669, 4983, 14121, 4506, 36109, 21399, 40443, 24582, 59001, 2074, 1724, 44069, 56322, 29104, 21766, 7167, 4725, 1399, 1321, 7578, 4877, 1431, 2043, 5126, 5241, 5146, 3772, 549, 6146, 4528, 2310, 54564, 54564, 39155, 39155, 46185, 46185, 5760, 5760, 25597, 25597, 20469, 20469, 56049, 56049, 15307, 15307, 3364, 3364, 4851, 4851, 617, 617, 5760, 5760, 2557, 2557, 1525, 1525, 6385, 6385, 1483, 1483, 45221, 45221, 45221, 45221, 20870, 20870, 20870, 20870, 18191, 18191, 18191, 18191, 828, 828, 828, 828, 1701, 1701, 1701, 1701, 1414, 1414, 1414, 1414, 2319, 2319, 2319, 2319, 2876, 2876, 2876, 2876, 60562, 60562, 60562, 60562, 60562, 60562, 60562, 60562, 14744, 14744, 14744, 14744, 14744, 14744, 14744, 14744, 2194, 2194, 2194, 2194, 2194, 2194, 2194, 2194, 2456, 2456, 2456, 2456, 2456, 2456, 2456, 2456, 49112, 49112, 4056, 4056, 55682, 35111, 21869, 21954, 63344, 38737, 32329, 38873, 40819, 62815, 7415, 51603, 63668, 7509, 24744, 51996, 5506, 6951, 7021, 4546, 6000, 5457, 3145, 1497, 6515, 5983, 3831, 915, 4276, 4949, 4264, 4892, 19317, 26220, 55127, 16092, 52926, 38404, 53574, 41484, 3456, 32798, 48506, 50178, 35665, 38336, 17602, 1690, 373, 3692, 2391, 1756, 4798, 3588, 1350, 2572, 3456, 1054, 2426, 2, 2385, 5568, 194, 4762, 21067, 28839, 50912, 5913, 26280, 35870, 59291, 39308, 23242, 49257, 44863, 53745, 49539, 11783, 5930, 6818, 7243, 679, 1760, 1305, 5800, 4126, 4507, 396, 1738, 3689, 4415, 4081, 7043, 7, 810, 5794, 23490, 23490, 34360, 34360, 62422, 62422, 15751, 15751, 62721, 62721, 42969, 42969, 19394, 19394, 7492, 7492, 6082, 6082, 5688, 5688, 2006, 2006, 3975, 3975, 4865, 4865, 5593, 5593, 1986, 1986, 5444, 5444, 18242, 18242, 18242, 18242, 42943, 42943, 42943, 42943, 53881, 53881, 53881, 53881, 23754, 23754, 23754, 23754, 834, 834, 834, 834, 2495, 2495, 2495, 2495, 121, 121, 121, 121, 2250, 2250, 2250, 2250, 58293, 58293, 58293, 58293, 58293, 58293, 58293, 58293, 4497, 4497, 4497, 4497, 4497, 4497, 4497, 4497, 6581, 6581, 6581, 6581, 6581, 6581, 6581, 6581, 3985, 3985, 3985, 3985, 3985, 3985, 3985, 3985, 10350, 10350, 3182, 3182, 32508, 32508, 1788, 1788};

#define Q OKAI_Q
#define MONT 4088 // ((1U << 16) % OKAI_Q)
#define QINV 57857 // q^-1 mod 2^16
#define V (((1U << 27) + Q/2)/Q)
#define FHI (MONT * (MONT * (Q - 1) * ((Q - 1)/128) % Q) % Q)
#define FLO (FHI * QINV % 65536)
#define MONTSQHI (MONT * MONT % Q)
#define MONTSQLO (MONTSQHI * QINV % 65536)
#define MASK 8191  // ((1U << 13) - 1)
#define MASK3 7  // ((1U << 3) - 1)
#define MASK8 255
#define MASK9 511
#define MASK10 1023
#define HALFQ Q / 2
#define HALFQC (Q + 1) / 2
#define MAGIC 8737
#define MAGIC2 35786735

const qdata_t qdata = {{
#define _16Q 0
  Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q,

#define _16QINV 16
  QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV,
  QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV,

#define _16V 32
  V, V, V, V, V, V, V, V, V, V, V, V, V, V, V, V,

#define _16ZERO 48
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,

#define _ZETAS_EXP 64
   28865, 28865, 28865, 28865, 3777, 3777, 3777, 3777,
   0, 0, 0, 0, 0, 0, 0, 0,
  -10350, -10350, -10350, -10350, -10350, -10350, -10350, -10350,
  -10350, -10350, -10350, -10350, -10350, -10350, -10350, -10350,
  -3182, -3182, -3182, -3182, -3182, -3182, -3182, -3182,
  -3182, -3182, -3182, -3182, -3182, -3182, -3182, -3182,
  -4496, -4496, -4496, -4496, -4496, -4496, -4496, -4496,
   7244, 7244, 7244, 7244, 7244, 7244, 7244, 7244,
   3696, 3696, 3696, 3696, 3696, 3696, 3696, 3696,
   1100, 1100, 1100, 1100, 1100, 1100, 1100, 1100,
   -23754, -23754, -23754, -23754, 11655, 11655, 11655, 11655,
   22593, 22593, 22593, 22593, -18242, -18242, -18242, -18242,
   -2250, -2250, -2250, -2250, -121, -121, -121, -121,
   -2495, -2495, -2495, -2495, -834, -834, -834, -834,
   -7491, -7491, -19394, -19394, 22568, 22568, 2816, 2816,
   -15750, -15750, 3114, 3114, 31177, 31177, -23489, -23489,
    2237, 2237, -1986, -1986, 2088, 2088, 2816, 2816,
    3706, 3706, -2006, -2006, 1993, 1993, 1599, 1599,
   -6817, -5930, -11783, 15998, 11792, 20674, 16279, -23242,
    26228, 6246, 29667, -26279, -5913, 14624, -28839, -21066,
    1887, -810, -7, 638, 3600, 3266, -3689, -1738,
   -396, 3174, 3555, 1881, -1305, -1760, -679, 438,
   -1689, -17602, 27201, 29871, 15358, 17030, 32738, -3456,
    24052, 11962, 27132, 12611, -16092, 10409, -26220, -19317,
    2919, -194, 2113, -2385, -2, -2426, -1054, -3456,
   -2572, -1350, -3588, 2883, -1756, -2391, -3692, -373,
    13541, -24743, -7508, 1869, 13933, -7415, 2722, 24718,
    26663, -32329, 26800, 2193, -21953, -21868, 30426, 9855,
    2789, 3417, 2732, 3405, -915, -3831, 1698, 1166,
   -1497, -3145, 2224, 1681, 3135, 660, 730, 2175,
    16425, 16425, 16425, 16425, 16425, 16425, 16425, 16425,
    16425, 16425, 16425, 16425, 16425, 16425, 16425, 16425,
    3625, 3625, 3625, 3625, 3625, 3625, 3625, 3625,
    3625, 3625, 3625, 3625, 3625, 3625, 3625, 3625,
   -14744, -14744, -14744, -14744, -14744, -14744, -14744, -14744,
    4974, 4974, 4974, 4974, 4974, 4974, 4974, 4974,
   -2456, -2456, -2456, -2456, -2456, -2456, -2456, -2456,
   -2194, -2194, -2194, -2194, -2194, -2194, -2194, -2194,
   -828, -828, -828, -828, -18191, -18191, -18191, -18191,
   -20870, -20870, -20870, -20870, 20315, 20315, 20315, 20315,
   -2876, -2876, -2876, -2876, -2319, -2319, -2319, -2319,
   -1414, -1414, -1414, -1414, -1701, -1701, -1701, -1701,
   -15307, -15307, 9488, 9488, -20469, -20469, -25597, -25597,
   -5759, -5759, 19351, 19351, 26382, 26382, 10972, 10972,
   -1483, -1483, 1296, 1296, -1525, -1525, -2557, -2557,
    1921, 1921, -617, -617, 2830, 2830, -3364, -3364,
   -21766, -29103, 9215, 21467, -1724, -2073, 6536, -24581,
    25093, -21399, 29428, -4505, -14121, -4983, -23668, -14846,
   -2310, 3153, 1535, -549, -3772, 2535, 2440, 2555,
   -2043, -1431, 2804, 103, -1321, -1399, 2956, 514, 
    26441, 26262, -24573, 12073, 15810, -24266, 8908, -8472, 
    15768, -10478, -13575, -16655, -12269, -6032, 22124, 32252,
   -2743, -1386, -1533, -727, -1598, -2762, 2764, 3816, 
    3480, -3310, -1799, -783, 2579, 2160, -404, 1532, 
    5529, 21860, 30136, -14351, -8558, -25946, 12013, 23225,
    4693, -9360, -17303, -17440, 22875, 25511, -3558, 9599,
    921, 3428, 1464, 1521, -1390, 3750, -2835, 2233,
    2133, -1168, 2665, -1056, 859, -2649, -486, 1919
}};

const uint16_t _16xq[16]  __attribute__((aligned(32))) = {Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q, Q};
const uint16_t _16xqinv[16] __attribute__((aligned(32))) = {QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV, QINV};
const uint16_t _16xv[16] __attribute__((aligned(32))) = {V, V, V, V, V, V, V, V, V, V, V, V, V, V, V, V};
const uint16_t _16xflo[16] __attribute__((aligned(32))) = {FLO, FLO, FLO, FLO, FLO, FLO, FLO, FLO, FLO, FLO, FLO, FLO, FLO, FLO, FLO, FLO};
const uint16_t _16xfhi[16] __attribute__((aligned(32))) = {FHI, FHI, FHI, FHI, FHI, FHI, FHI, FHI, FHI, FHI, FHI, FHI, FHI, FHI, FHI, FHI};
const uint16_t _16xmontsqlo[16] __attribute__((aligned(32))) = {MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO, MONTSQLO};
const uint16_t _16xmontsqhi[16] __attribute__((aligned(32))) = {MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI, MONTSQHI};
const uint16_t _16xmask[16] __attribute__((aligned(32))) = {MASK, MASK, MASK, MASK, MASK, MASK, MASK, MASK, MASK, MASK, MASK, MASK, MASK, MASK, MASK, MASK};
const uint16_t _16xmask3[16] __attribute__((aligned(32))) = {MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3, MASK3};
const uint16_t _16xmask8[16] __attribute__((aligned(32))) = {MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8, MASK8};
const uint16_t _16xmask9[16] __attribute__((aligned(32))) = {MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9, MASK9};
const uint16_t _16xmask10[16] __attribute__((aligned(32))) = {MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10, MASK10};
const uint16_t _16xhalfq[16]  __attribute__((aligned(32))) = {HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ};
const uint16_t _16xhalfqc[16]  __attribute__((aligned(32))) = {HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC};
const uint32_t _8xhalfq[8] __attribute__((aligned(32))) = {HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ, HALFQ};
const uint32_t _8xhalfqc[8] __attribute__((aligned(32))) = {HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC, HALFQC};
const uint32_t _8xq[8] __attribute__((aligned(32))) = {Q, Q, Q, Q, Q, Q, Q, Q};
const uint16_t _16xmagic[16] __attribute__((aligned(32))) = {MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC};
const uint32_t _8xmagic[8] __attribute__((aligned(32))) = {MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC, MAGIC};
const uint64_t _4xmagic[4]  __attribute__((aligned(32))) = {MAGIC2, MAGIC2, MAGIC2, MAGIC2};
const uint8_t maskshuf[32] __attribute__((aligned(32))) = {0x00, 0x01, 0x04, 0x05, 0x08, 0x09, 0x0c, 0x0d, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x01, 0x04, 0x05, 0x08, 0x09, 0x0c, 0x0d, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff};
const uint16_t _16x1[16] __attribute__((aligned(32))) = {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1};
const uint16_t _16x2[16] __attribute__((aligned(32))) = {2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2};
const uint16_t _16x4[16] __attribute__((aligned(32))) = {4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4};
const uint16_t _16x7[16] __attribute__((aligned(32))) = {7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7};
const uint32_t _8x128[8] __attribute__((aligned(32))) = {128, 128, 128, 128, 128, 128, 128, 128};
const uint32_t _8x256[8] __attribute__((aligned(32))) = {256, 256, 256, 256, 256, 256, 256, 256};
const uint32_t _8x512[8] __attribute__((aligned(32))) = {512, 512, 512, 512, 512, 512, 512, 512};
const uint32_t _8x1[8] __attribute__((aligned(32))) = {1, 1, 1, 1, 1, 1, 1, 1};
const uint32_t _8x15[8] __attribute__((aligned(32))) = {15, 15, 15, 15, 15, 15, 15, 15};
const uint32_t _8x4[8] __attribute__((aligned(32))) = {4, 4, 4, 4, 4, 4, 4, 4};
const uint16_t yhat[256] __attribute__((aligned(32))) = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088};

#undef Q
#undef QINV
#undef MONT
#undef V
#undef FLO
#undef FHI
#undef MONTSQLO
#undef MONTSQHI
#undef MASK